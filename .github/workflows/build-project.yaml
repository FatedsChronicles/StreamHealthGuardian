name: CI (Build)
on:
  push:
  pull_request:

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add OBS PPA + install dependencies
        run: |
          sudo add-apt-repository -y ppa:obsproject/obs-studio
          sudo apt-get update
          # OBS SDK + Qt6 + build tools + (fixes XKB warning)
          sudo apt-get install -y \
            libobs-dev \
            qt6-base-dev qt6-base-dev-tools \
            libxkbcommon-dev \
            cmake ninja-build build-essential

      - name: Configure (system packages)
        run: |
          cmake -B build -S . -G Ninja \
            -DENABLE_FRONTEND_API=ON \
            -DENABLE_QT=ON \
            -DPLUGIN_WERROR=OFF \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp build/*.so artifacts/ 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        with:
          name: ubuntu-artifacts
          path: artifacts

  macos:
  runs-on: macos-latest
  steps:
    - uses: actions/checkout@v4

    - name: Install tools
      run: |
        brew update
        brew install cmake ninja git qt@6
        echo "::add-path::/usr/local/opt/qt@6/bin"
        echo "CMAKE_PREFIX_PATH=/usr/local/opt/qt@6/lib/cmake" >> $GITHUB_ENV

    - name: Prepare directories
      run: |
        mkdir -p $GITHUB_WORKSPACE/_deps
        mkdir -p $GITHUB_WORKSPACE/_prefix   # where LibObs will be installed

    - name: Download obs-deps (macOS)
      run: |
        # Use the version from your buildspec.json (example URL pattern below).
        # Replace the URL/version if needed.
        cd $GITHUB_WORKSPACE/_deps
        curl -L -o obs-deps-macos.tar.xz \
          https://github.com/obsproject/obs-deps/releases/download/2025-07-11/macos-deps-2025-07-11.tar.xz
        tar -xf obs-deps-macos.tar.xz
        # Result: a deps tree weâ€™ll pass as DepsPath

    - name: Clone obs-studio
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth 1 --branch 31.1.1 https://github.com/obsproject/obs-studio.git
        # If your buildspec.json uses a different version, match it here.

    - name: Build LibObs
      run: |
        cd $GITHUB_WORKSPACE/obs-studio
        cmake -B build -S . -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DDepsPath="$GITHUB_WORKSPACE/_deps" \
          -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/_prefix" \
          -DBUILD_BROWSER=OFF -DBUILD_VST=OFF -DBUILD_QSV=OFF
        cmake --build build --target obs --config Release -j
        cmake --install build

    - name: Configure plugin (point to LibObs prefix)
      run: |
        cmake -B build -S . -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_FRONTEND_API=ON \
          -DENABLE_QT=ON \
          -DPLUGIN_WERROR=OFF \
          -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/_prefix/lib/cmake;${{ env.CMAKE_PREFIX_PATH }}"

    - name: Build plugin
      run: cmake --build build -j

    - name: Collect artifacts
      run: |
        mkdir -p artifacts
        cp build/*.so artifacts/ 2>/dev/null || true
        cp build/*.dylib artifacts/ 2>/dev/null || true
    - uses: actions/upload-artifact@v4
      with:
        name: macos-artifacts
        path: artifacts


  windows:
  runs-on: windows-latest
  steps:
    - uses: actions/checkout@v4

    - name: MSVC Dev Cmd
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install tools
      shell: pwsh
      run: |
        choco install ninja cmake git -y
        # Optional: install Qt 6 (tools only). On hosted runners, you may need to fetch official Qt instead.
        choco install qt6-default -y || echo "If this fails, we will rely on obs-deps' Qt or adjust CMAKE_PREFIX_PATH later."

    - name: Prepare directories
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path $env:GITHUB_WORKSPACE\_deps | Out-Null
        New-Item -ItemType Directory -Force -Path $env:GITHUB_WORKSPACE\_prefix | Out-Null

    - name: Download obs-deps (Windows)
      shell: pwsh
      run: |
        cd $env:GITHUB_WORKSPACE\_deps
        # Match the version/date to your buildspec.json
        Invoke-WebRequest -Uri https://github.com/obsproject/obs-deps/releases/download/2025-07-11/windows-deps-2025-07-11-x64.zip -OutFile deps.zip
        Expand-Archive deps.zip -DestinationPath $env:GITHUB_WORKSPACE\_deps

    - name: Clone obs-studio
      shell: pwsh
      run: |
        cd $env:GITHUB_WORKSPACE
        git clone --depth 1 --branch 31.1.1 https://github.com/obsproject/obs-studio.git

    - name: Build LibObs
      shell: pwsh
      run: |
        cd $env:GITHUB_WORKSPACE\obs-studio
        cmake -B build -S . -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DDepsPath="$env:GITHUB_WORKSPACE\_deps" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\_prefix" `
          -DBUILD_BROWSER=OFF -DBUILD_VST=OFF -DBUILD_QSV=OFF
        cmake --build build --target obs --config Release -j
        cmake --install build

    - name: Configure plugin (point to LibObs prefix)
      shell: pwsh
      run: >
        cmake -B build -S . -G Ninja
        -DCMAKE_BUILD_TYPE=Release
        -DENABLE_FRONTEND_API=ON
        -DENABLE_QT=ON
        -DPLUGIN_WERROR=OFF
        -DCMAKE_PREFIX_PATH="$env:GITHUB_WORKSPACE\_prefix\lib\cmake"

    - name: Build plugin
      run: cmake --build build --config Release -j

    - name: Collect artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path artifacts | Out-Null
        Copy-Item build\*.dll artifacts -ErrorAction SilentlyContinue
    - uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: artifacts

